



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-0.17.5, mkdocs-material-2.9.2">
    
    
      
        <title>Virtualization SDK</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.fbb7f3af.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica+Neue:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Helvetica Neue","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#data-ingestion" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Delphix Virtualization SDK" class="md-header-nav__button md-logo">
          
            <img src="../../images/delphix-logo-white.png" width="153" height="15">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Delphix Virtualization SDK
              </span>
              <span class="md-header-nav__topic">
                Data Ingestion
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../images/delphix-logo-white.png" width="48" height="48">
      
    </span>
    Delphix Virtualization SDK
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome!" class="md-nav__link">
      Welcome!
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Getting_Started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Your First Plugin
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Your First Plugin
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Discovery/" title="Discovery" class="md-nav__link">
      Discovery
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data Ingestion
      </label>
    
    <a href="./" title="Data Ingestion" class="md-nav__link md-nav__link--active">
      Data Ingestion
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-does-delphix-ingest-data" title="How Does Delphix Ingest Data?" class="md-nav__link">
    How Does Delphix Ingest Data?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linking" title="Linking" class="md-nav__link">
    Linking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#syncing" title="Syncing" class="md-nav__link">
    Syncing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#our-syncing-strategy" title="Our Syncing Strategy" class="md-nav__link">
    Our Syncing Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-your-linked-source-data-format" title="Defining Your Linked Source Data Format" class="md-nav__link">
    Defining Your Linked Source Data Format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-syncing-in-your-plugin" title="Implementing Syncing in Your Plugin" class="md-nav__link">
    Implementing Syncing in Your Plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-link-and-sync-in-the-delphix-engine" title="How to Link and Sync in the Delphix Engine" class="md-nav__link">
    How to Link and Sync in the Delphix Engine
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Provisioning/" title="Provisioning" class="md-nav__link">
      Provisioning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      References
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Decorators/" title="Decorators" class="md-nav__link">
      Decorators
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Plugin_Operations/" title="Plugin Operations" class="md-nav__link">
      Plugin Operations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Workflows/" title="Workflows" class="md-nav__link">
      Workflows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Classes/" title="Classes" class="md-nav__link">
      Classes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Schemas/" title="Schemas" class="md-nav__link">
      Schemas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Schemas_and_Autogenerated_Classes/" title="Schemas and Autogenerated Classes" class="md-nav__link">
      Schemas and Autogenerated Classes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/CLI/" title="CLI" class="md-nav__link">
      CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Plugin_Versioning/" title="Plugin Versioning" class="md-nav__link">
      Plugin Versioning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../References/Logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Best Practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Best Practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Best_Practices/Sensitive_Data/" title="Dealing With Sensitive Data" class="md-nav__link">
      Dealing With Sensitive Data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-does-delphix-ingest-data" title="How Does Delphix Ingest Data?" class="md-nav__link">
    How Does Delphix Ingest Data?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linking" title="Linking" class="md-nav__link">
    Linking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#syncing" title="Syncing" class="md-nav__link">
    Syncing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#our-syncing-strategy" title="Our Syncing Strategy" class="md-nav__link">
    Our Syncing Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-your-linked-source-data-format" title="Defining Your Linked Source Data Format" class="md-nav__link">
    Defining Your Linked Source Data Format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-syncing-in-your-plugin" title="Implementing Syncing in Your Plugin" class="md-nav__link">
    Implementing Syncing in Your Plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-link-and-sync-in-the-delphix-engine" title="How to Link and Sync in the Delphix Engine" class="md-nav__link">
    How to Link and Sync in the Delphix Engine
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="data-ingestion">Data Ingestion<a class="headerlink" href="#data-ingestion" title="Permanent link">&para;</a></h1>
<h2 id="how-does-delphix-ingest-data">How Does Delphix Ingest Data?<a class="headerlink" href="#how-does-delphix-ingest-data" title="Permanent link">&para;</a></h2>
<p>As discussed in the <a href="../../References/Your_First_Plugin/Discovery">previous page</a>, the Delphix Engine uses the <a href="../../References/Glossary/#discovery">discovery</a> process to learn about datasets that live on a <a href="../../References/Glossary/#source-environment">source environment</a>. This section describes how we ingest such a dataset into the Delphix Engine. It is a two-step process.</p>
<h3 id="linking">Linking<a class="headerlink" href="#linking" title="Permanent link">&para;</a></h3>
<p>The first step is called <a href="../../References/Glossary/#linking">linking</a>. This is simply the creation of a new dataset on the Delphix Engine, which is associated with the dataset on the source environment. This new linked dataset is called a <a href="../../References/Glossary/#dsource">dSource</a>.</p>
<h3 id="syncing">Syncing<a class="headerlink" href="#syncing" title="Permanent link">&para;</a></h3>
<p>Immediately after linking, the new dSource is <a href="../../References/Glossary/#syncing">synced</a>. This is the process by which data from the source environment is copied onto the Delphix Engine. Subsequent syncs may then be periodically performed in order to keep the dSource up-to-date.</p>
<p>The details of how this copying is done will vary significantly from plugin to plugin. For example, some plugins will simply copy files from the filesystem. Other plugins might contact a DBMS and instruct it to send backup or replication streams. There are many possibilities here, but they all break down into two main strategies that the plugin author can choose from:</p>
<p>With the <a href="../../References/Glossary/#direct-linkingsyncing">direct</a> strategy, the plugin is not in charge of the data copying. Instead the Delphix Engine will directly pull raw data from the source environment, using the Unix tool <code>rsync</code> (or <code>robocopy</code> on Windows). The plugin merely provides the location of the data. This is a very simple strategy, and it is also quite limiting.</p>
<p>For our first plugin, we'll be using the more flexible <a href="../../References/Glossary/#staged-linkingsyncing">staging</a> strategy. With this strategy, the Delphix Engine will use NFS (or CIFS on Windows) to mount storage onto a <a href="../../References/Glossary/#staging-environment">staging environment</a>. Our plugin will then be in full control of how to get data from the source environment onto this NFS mount.</p>
<div class="admonition note">
<p class="admonition-title">Gotcha</p>
<p>Although it is not common, it is entirely possible that the staging environment is the same thing as the source environment. Be careful not to assume otherwise in your plugins.</p>
</div>
<p>For more details about deciding between using a direct or a staging strategy, please see (link to best practices section).</p>
<h3 id="our-syncing-strategy">Our Syncing Strategy<a class="headerlink" href="#our-syncing-strategy" title="Permanent link">&para;</a></h3>
<p>For our purposes here in this intro plugin, we'll use a simple strategy. We'll simply copy files from the filesystem on the source environment onto the NFS mount on the staging environment. We'll do this by running <code>scp</code> from our staging environment, and use user-provided credentials to connect to the source environment.</p>
<p>For simplicity's sake, we will not bother handling the case mentioned above where the staging environment is the same as the source environment</p>
<h2 id="defining-your-linked-source-data-format">Defining Your Linked Source Data Format<a class="headerlink" href="#defining-your-linked-source-data-format" title="Permanent link">&para;</a></h2>
<p>In order to be able to successfully do the copying required, plugins might need to get some information from the user. In our case, we will need to connect from the staging environment to the source environment using the <code>scp</code> tool. This means we will need to know a username and password.</p>
<p>Again, we will be using a JSON schema to define the data format. The user will be presented with a UI that will let them provide all the information our schema specifies.</p>
<p>(TODO: describe where to put this schema)</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">],</span>
    <span class="nt">&quot;properties&quot;</span> <span class="p">{</span>
        <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="nt">&quot;prettyName&quot;</span><span class="p">:</span> <span class="s2">&quot;Username on Source Host&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Username for making SSH connection to source host&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="nt">&quot;prettyName&quot;</span><span class="p">:</span> <span class="s2">&quot;Password on Source Host&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Password for making SSH connection to source host&quot;</span><span class="p">,</span>
            <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>There is one new thing to notice about this schema, as compared with our discovery schemas. The <code>password</code> property is tagged as <a href="../../References/Glossary/#password-property"><code>"format": "password"</code></a>. This ensures that the Delphix Engine will take precautions like not displaying the value on-screen. For full details, see (link to reference section).</p>
<p>With this schema, the user will be required to provide a username and password as part of the linking process.</p>
<h2 id="implementing-syncing-in-your-plugin">Implementing Syncing in Your Plugin<a class="headerlink" href="#implementing-syncing-in-your-plugin" title="Permanent link">&para;</a></h2>
<p>As explained here (link to reference flowchart), the Delphix Engine will always run the plugin's <code>preSnapshot</code> operation just before taking a snapshot of the dsource. That means our <code>preSnapshot</code> operation has to get the NFS share into the desired state. For us, that means that's the time to do our data copy.</p>
<p>Create a file in your preferred editor (TODO: add suggested/required filename), and add the following Python code. (TODO: revisit when decorators are finalized)</p>
<div class="codehilite"><pre><span></span><span class="nd">@delphix.linked_pre_snapshot</span>
<span class="k">def</span> <span class="nf">copy_data_from_source</span><span class="p">(</span><span class="n">source_environment</span><span class="p">,</span> <span class="n">staging_environment</span><span class="p">,</span> <span class="n">source_config</span><span class="p">,</span> <span class="n">linked_source</span><span class="p">,</span> <span class="n">mount_location</span><span class="p">):</span>
    <span class="n">environment_variables</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;PASSWORD&quot;</span><span class="p">:</span> <span class="n">linked_source</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span>
    <span class="n">scp_data_location</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linked_source</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">source_environment</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">source_config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">scp_command</span> <span class="o">=</span> <span class="s2">&quot;echo $PASSWORD | scp -r </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scp_data_location</span><span class="p">,</span> <span class="n">mount_location</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">run_bash</span><span class="p">(</span><span class="n">staging_environment</span><span class="p">,</span> <span class="n">copy_command</span><span class="p">,</span> <span class="n">environment_variables</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not copy files. Please check username and password.</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</pre></div>


<p>Taking this line-by-line, here's what's happening in our new method:</p>
<div class="codehilite"><pre><span></span><span class="nd">@delphix.linked_pre_snapshot</span>
</pre></div>


<p>This <a href="../../References/Glossary/#password-property">decorator</a> tells the Delphix Engine that this code will define our "pre-snapshot" operation.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">copy_data_from_source</span><span class="p">(</span><span class="n">source_environment</span><span class="p">,</span> <span class="n">staging_environment</span><span class="p">,</span> <span class="n">source_config</span><span class="p">,</span> <span class="n">linked_source</span><span class="p">,</span> <span class="n">mount_location</span><span class="p">):</span>
</pre></div>


<p>This begins the Python function that implements our pre-snapshot operation. As compared with our discovery code, there are a lot more inputs coming in from the Delphix Engine.</p>
<div class="admonition note">
<p class="admonition-title">Gotcha</p>
<p>The order of these input arguments matters. That is, the first input argument is always going to represent the source environment, the second the staging environment, and so on. It's highly recommended to use these same variable names to avoid confusion.</p>
</div>
<div class="codehilite"><pre><span></span>    <span class="n">environment_variables</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;PASSWORD&quot;</span><span class="p">:</span> <span class="n">linked_source</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span>
    <span class="n">scp_data_location</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linked_source</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">source_environment</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">source_config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">scp_command</span> <span class="o">=</span> <span class="s2">&quot;echo $PASSWORD | scp -r </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scp_data_location</span><span class="p">,</span> <span class="n">mount_location</span><span class="p">)</span>
</pre></div>


<p>Here, we are preparing data to help us run a Bash command on the staging host. First, we set up a Python dictionary that represents the environment variables we want. Next, we construct a Python string that represents the actual command we want to run.</p>
<p>Note that we are using the <code>scp</code> tool to copy files from the source environment onto the NFS share that is mounted to the staging environment.</p>
<div class="codehilite"><pre><span></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">run_bash</span><span class="p">(</span><span class="n">staging_environment</span><span class="p">,</span> <span class="n">copy_command</span><span class="p">,</span> <span class="n">environment_variables</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not copy files. Please check username and password.</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</pre></div>


<p>This code actually runs the Bash command. The function <code>run_bash</code> that we're calling here is a called a <a href="../../References/Glossary/#callback">callback</a>. Plugins use callbacks to request that the Delphix Engine do work on the plugin's behalf. In our case, we are telling the Delphix Engine to run our bash command on the staging environment.</p>
<p>We also check that the command succeeded. If not, we will raise an error that explains the situation to the user.</p>
<p>For full details on the <code>run_bash</code> callback, and on callbacks in general, please see (link to reference).</p>
<h2 id="how-to-link-and-sync-in-the-delphix-engine">How to Link and Sync in the Delphix Engine<a class="headerlink" href="#how-to-link-and-sync-in-the-delphix-engine" title="Permanent link">&para;</a></h2>
<p>Let's try it out and make sure this works!</p>
<p>You should already have a respository and source config set up from the previous page.</p>
<p>Next, you should set up a separate staging environment. (TODO: add instructions here)</p>
<p>Go to "Manage/Environments", select your <strong>source</strong> environment, and then go to the "Databases" tab. Find your "Directory Tree" repository, and your source config underneath it.</p>
<p>Click "Add dSource" on your source config. This will begin the linking process.</p>
<p>You should be presented with a UI in which you will have to specify which environment you want to use for staging. You will also be asked to provide the username and password needed to connect to the source environment.</p>
<p>After you have finished entering this information, the initial sync process will begin. This is what will call your pre-snapshot operation, thus copying data.</p>
<div class="admonition note">
<p class="admonition-title">Gotcha</p>
<p>Once you've manually created a dsource, you will not be allowed to modify your plugin's linked source schema. We'll cover how to deal with this correctly later, in the upgrade section. For now, if you need to change your plugin's linked source schema, you'll have to first delete any dsources you've manually added.</p>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Discovery/" title="Discovery" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Discovery
              </span>
            </div>
          </a>
        
        
          <a href="../Provisioning/" title="Provisioning" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Provisioning
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Delphix Corp.
          </div>
        
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://www.delphix.com/" class="md-footer-social__link fa fa-sitemap"></a>
    
      <a href="https://www.facebook.com/DelphixCorp/" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://twitter.com/delphix" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/delphix" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://github.com/delphix" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.878fdd8d.js"></script>
      
      <script>app.initialize({version:"0.17.5",url:{base:"../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-35429885-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>