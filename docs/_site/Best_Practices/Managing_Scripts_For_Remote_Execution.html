<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Managing Scripts for Remote Execution | virtualization-sdk</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Managing Scripts for Remote Execution" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/Best_Practices/Managing_Scripts_For_Remote_Execution.html" />
<meta property="og:url" content="http://localhost:4000/Best_Practices/Managing_Scripts_For_Remote_Execution.html" />
<meta property="og:site_name" content="virtualization-sdk" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/Best_Practices/Managing_Scripts_For_Remote_Execution.html","headline":"Managing Scripts for Remote Execution","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=52f3c2ef1003e9fe35bc8813a5d4baa843da74c1">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">virtualization-sdk</a></h1>
      

      <h1 id="managing-scripts-for-remote-execution">Managing Scripts for Remote Execution</h1>

<p>To execute a PowerShell or Bash script or Expect script on a remote host, you must provide the script as a string to <code class="highlighter-rouge">run_powershell</code> or <code class="highlighter-rouge">run_bash</code> or <code class="highlighter-rouge">run_expect</code>. While you can keep these strings as literals in your Python code, best practice is to keep them as resource files in your source directory and access them with <code class="highlighter-rouge">pkgutil</code>.</p>

<p><a href="https://docs.python.org/2/library/pkgutil.html">pkgutil</a> is part of the standard Python library. The method that is applicable to resources is <a href="https://docs.python.org/2/library/pkgutil.html#pkgutil.get_data">pkgutil.get_data</a>.</p>

<h3 id="basic-usage">Basic Usage</h3>

<p>Given the following plugin structure:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── plugin_config.yml
├── schema.json
└── src
    ├── plugin_runner.py
    └── resources
        ├── __init__.py
        └── get_date.sh
</code></pre></div></div>

<p>Assume <code class="highlighter-rouge">SnapshotDefinition</code> is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"snapshotDefinition": {
    "type" : "object",
    "additionalProperties" : false,
    "properties" : {
        "name": {"type": "string"},
        "date": {"type": "string"}
    }
}
</code></pre></div></div>

<p>and <code class="highlighter-rouge">src/resources/get_date.sh</code> contains:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
date
</code></pre></div></div>

<p>If <code class="highlighter-rouge">get_date.sh</code> is needed in <code class="highlighter-rouge">post_snapshot</code>, it can be retrieved and executed:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pkgutil</span>

<span class="kn">from</span> <span class="nn">dlpx.virtualization</span> <span class="kn">import</span> <span class="n">libs</span>
<span class="kn">from</span> <span class="nn">dlpx.virtualization.platform</span> <span class="kn">import</span> <span class="n">Plugin</span>

<span class="kn">from</span> <span class="nn">generated.definitions</span> <span class="kn">import</span> <span class="n">SnapshotDefinition</span>


<span class="n">plugin</span> <span class="o">=</span> <span class="n">Plugin</span><span class="p">()</span>

<span class="nd">@plugin.linked.post_snapshot</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">post_snapshot</span><span class="p">(</span><span class="n">direct_source</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">source_config</span><span class="p">):</span>
	<span class="c"># Retrieve script contents</span>
	<span class="n">script_content</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">'resources'</span><span class="p">,</span> <span class="s">'get_date.sh'</span><span class="p">)</span>

	<span class="c"># Execute script on remote host</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">libs</span><span class="o">.</span><span class="n">run_bash</span><span class="p">(</span><span class="n">direct_source</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">script_content</span><span class="p">)</span>

	<span class="c"># Fail operation if the timestamp couldn't be retrieved</span>
	<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Failed to get date: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>

	<span class="k">return</span> <span class="n">SnapshotDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Snapshot'</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</code></pre></div></div>

<p>!!! note “Python’s Working Directory”
	This assumes that <code class="highlighter-rouge">src/</code> is Python’s current working directory. This is the behavior of the Virtualization Platform.</p>

<p>!!! warning “Resources need to be in a Python module”
	<code class="highlighter-rouge">pkgutil.get_data</code> cannot retrieve the contents of a resource that is not in a Python package. This means that a resource that is in the first level of your source directory will not be retrievable with <code class="highlighter-rouge">pkgutil</code>. Resources must be in a subdirectory of your source directory, and that subdirectory must contain an <code class="highlighter-rouge">__init__.py</code> file.</p>

<h3 id="multi-level-packages">Multi-level Packages</h3>

<p>Given the following plugin structure:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── plugin_config.yml
├── schema.json
└── src
    ├── plugin_runner.py
    └── resources
        ├── __init__.py
        ├── database
        │   ├── __init__.py
        │   └── execute_sql.sh
        └── platform
            ├── __init__.py
            └── get_date.sh
</code></pre></div></div>

<p>The contents of <code class="highlighter-rouge">src/resources/platform/get_date.sh</code> can be retrieved with:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">script_content</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">'resources.platform'</span><span class="p">,</span> <span class="s">'get_date.sh'</span><span class="p">)</span>
</code></pre></div></div>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
